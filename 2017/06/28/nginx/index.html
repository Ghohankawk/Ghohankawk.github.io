<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nginx入门系列一 · 闻道</title><meta name="description" content="nginx入门系列一 - 韩坤"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-9654808400771776",
    enable_page_level_ads: true
});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject'] = r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-100775956-1', 'auto');
ga('send', 'pageview');
</script><link rel="search" type="application/opensearchdescription+xml" href="http://ghohankawk.github.io/atom.xml" title="闻道"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">闻道</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives/" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/about.html" target="_self" class="li component-nav-item"><p>关于我</p></a><a href="https://ghohankawk.gitbooks.io/book/content/" target="_blank" class="li component-nav-item"><p>个人书籍</p></a><ul class="shortcut-icons"><a href="http://blog.csdn.net/ghohankawk" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">nginx入门系列一</h1><div class="post-info">Jun 28, 2017</div><div class="post-content"><h1 id="今天要分享的内容是nginx的基本知识"><a href="#今天要分享的内容是nginx的基本知识" class="headerlink" title="今天要分享的内容是nginx的基本知识"></a>今天要分享的内容是nginx的基本知识</h1><h1 id="先看一下conf文件解释"><a href="#先看一下conf文件解释" class="headerlink" title="先看一下conf文件解释"></a>先看一下conf文件解释</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"># vi nginx.conf</div><div class="line"></div><div class="line">user	nobody nobody; #	运行 nginx 的所属组和所有者</div><div class="line"></div><div class="line">worker_processes	2; #	开启两个 nginx 工作进程,一般几个 CPU 核心就写几 </div><div class="line"></div><div class="line">error_log	logs/error.log	notice; #	错误日志路径</div><div class="line"></div><div class="line">pid	logs/nginx.pid; # pid 路径 </div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections	1024; #	一个进程能同时处理 1024 个请求</div><div class="line">    &#125;</div><div class="line">http &#123;</div><div class="line"></div><div class="line">include		mime.types; </div><div class="line"></div><div class="line">default_type	application/octet-stream;</div><div class="line"></div><div class="line">log_format	main	‘$remote_addr – $remote_user [$time_local] “$request” ‘ ‘$status $body_bytes_sent “$http_referer” ‘</div><div class="line">‘”$http_user_agent” “$http_x_forwarded_for”‘; </div><div class="line"></div><div class="line">access_log	logs/access.log	main; #	默认访问日志路径 sendfile		on;</div><div class="line"></div><div class="line">keepalive_timeout	65; # keepalive 超时时间</div><div class="line"></div><div class="line">#	开始配置一个域名,一个 server 配置段一般对应一个域名 </div><div class="line"></div><div class="line">server &#123;</div><div class="line">    </div><div class="line">listen	80; </div><div class="line"></div><div class="line">#	在本机所有 ip 上监听 80,也可以写为 192.168.1.202:80,这样的话,就只监听 192.168.1.202 上的 80 口 </div><div class="line"></div><div class="line">server_name	www.heytool.com; #	域名</div><div class="line"></div><div class="line">root		/www/html/www.heytool.com; #	站点根目录（程序目录）</div><div class="line"></div><div class="line">index	index.html index.htm; #	索引文件</div><div class="line"></div><div class="line">location / &#123;	#	可以有多个 location</div><div class="line">    root	/www/html/www.heytool.com; #	站点根目录（程序目录）</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">error_page	500 502 503 504	/50x.html;</div><div class="line"></div><div class="line">#	定义错误页面,如果是 500 错误,则把站点根目录下的 50x.html 返回给用户 </div><div class="line"></div><div class="line">location = /50x.html &#123;</div><div class="line">    root	/www/html/www.heytool.com;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#	开始配置站点</div><div class="line"> </div><div class="line">bbs.heytool.com server &#123;</div><div class="line">    listen	80;</div><div class="line">    server_name	bbs.heytool.com;  </div><div class="line">    root	/www/html/bbs.heytool.com;</div><div class="line">    index	index.html index.htm; #	索引文件 </div><div class="line">    location / &#123;</div><div class="line">    root	/www/html/bbs.heytool.com;</div><div class="line">      &#125;</div><div class="line">    error_page	500 502 503 504	/50x.html; </div><div class="line">    location = /50x.html &#123;</div><div class="line">    root	/www/html/bbs.heytool.com;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="nginx-启动，测试，关闭，重启"><a href="#nginx-启动，测试，关闭，重启" class="headerlink" title="nginx 启动，测试，关闭，重启"></a>nginx 启动，测试，关闭，重启</h1><pre><code># /usr/local/nginx-1.0.6/sbin/nginx    //启动 nginx
# /usr/local/nginx-1.0.6/sbin/nginx –t //测试 nginx 配置文件的准确性
# /usr/local/nginx-1.0.6/sbin/nginx –s reload //重载 nginx
# /usr/local/nginx-1.0.6/sbin/nginx –s stop //关闭 nginx
</code></pre><h1 id="nginx-配置虚拟主机"><a href="#nginx-配置虚拟主机" class="headerlink" title="nginx 配置虚拟主机"></a>nginx 配置虚拟主机</h1><p>也就是我们通常说的配置域名.</p>
<pre><code>server_name：虚拟主机的域名，可以写多个域名，类似于别名，比如说你可以配置成
server_name b.ttlsa.com c.ttlsa.com d.ttlsa.com，这样的话，访问任何一个域名，内容都是一样的 listen 80，监听 ip 和端口，这边仅仅只有端口，表示当前服务器所有 ip 的 80 端口，如果只想监听 127.0.0.1 的 80，写法如下：
listen 127.0.0.1:80
root /data/site/b.ttlsa.com：站点根目录，你网站文件存放的地方。注：站点目录和域名尽量一样，养成一个 好习惯
access_log /data/logs/nginx/b.ttlsa.com-access.log main：访问日志 location /{}
</code></pre><h1 id="nginx-location-配置"><a href="#nginx-location-配置" class="headerlink" title="nginx location 配置"></a>nginx location 配置</h1><p>语法规则： location [=|~|~*|^~] /uri/ { … }</p>
<ol>
<li>= 表示精确匹配,这个优先级也是最高的</li>
<li>^~ 表示 uri 以某个常规字符串开头，理解为匹配 url 路径即可。<br>nginx 不对 url 做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa 匹配到（注意是空格）。</li>
<li>~    表示区分大小写的正则匹配</li>
<li>~* 表示不区分大小写的正则匹配(和上面的唯一区别就是大小写)</li>
<li>!~和!~*分别为区分大小写不匹配及不区分大小写不匹配的正则</li>
<li>/ 通用匹配，任何请求都会匹配到，默认匹配. </li>
</ol>
<p>多个 location 配置的情况下匹配顺序为：</p>
<p>首先匹配 =，其次匹配^~, 其次是按文件中顺序的正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止 匹配，按当前匹配规则处理请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">例子，有如下匹配规则： </div><div class="line">location / </div><div class="line">    &#123;</div><div class="line">        echo &quot;/&quot;; //需要安装 echo 模块才行,这边大家可以改成各自的规则</div><div class="line">    &#125;</div><div class="line">location = / </div><div class="line">    &#123; </div><div class="line">    echo &quot;=/&quot;;</div><div class="line">    &#125;</div><div class="line">location = /nginx </div><div class="line">    &#123; </div><div class="line">    echo &quot;=/nginx&quot;;</div><div class="line">    &#125;</div><div class="line">location ~ \.(gif|jpg|png|js|css)$ </div><div class="line">    &#123; echo &quot;small-gif/jpg/png&quot;;</div><div class="line">    &#125;</div><div class="line">location ~* \.png$ </div><div class="line">    &#123; echo &quot;all-png&quot;;</div><div class="line">    &#125;</div><div class="line">location ^~ /static/ </div><div class="line">    &#123; echo &quot;static&quot;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>那么</p>
<ol>
<li><a href="http://a.ttlsa.com/，完全匹配=/" target="_blank" rel="external">http://a.ttlsa.com/，完全匹配=/</a></li>
<li><a href="http://a.ttlsa.com/nginx,完全匹配了”=/nginx”" target="_blank" rel="external">http://a.ttlsa.com/nginx,完全匹配了”=/nginx”</a></li>
<li><a href="http://a.ttlsa.com/xxx/1111.PNG" target="_blank" rel="external">http://a.ttlsa.com/xxx/1111.PNG</a> （注意,这是大写），最后匹配到了~* .png$</li>
<li><a href="http://a.ttlsa.com/static/1111.png,虽然" target="_blank" rel="external">http://a.ttlsa.com/static/1111.png,虽然</a> static 放在最后面,但是因为有^的缘故,他是最匹配的.</li>
</ol>
<h1 id="nginx-root-amp-alias-文件路径配置"><a href="#nginx-root-amp-alias-文件路径配置" class="headerlink" title="nginx root&amp;alias 文件路径配置"></a>nginx root&amp;alias 文件路径配置</h1><p>nginx 指定文件路径有两种方式 root 和 alias，root 与 alias 主要区别在于 nginx 如何解释 location 后面的 uri，这会使两者分别以不同的方式将请求映射到 服务器文件上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">例子一：</div><div class="line">location ~ ^/weblogs/ &#123;</div><div class="line">root /data/weblogs/www.ttlsa.com; autoindex on;</div><div class="line">auth_basic	&quot;Restricted&quot;; auth_basic_user_file	passwd/weblogs;</div><div class="line">&#125;</div><div class="line">如果一个请求的 URI 是/weblogs/httplogs/www.ttlsa.com-access.log 时，web 服务器将会返回服务器上的</div><div class="line">/data/weblogs/www.ttlsa.com/weblogs/httplogs/www.ttlsa.com-access.log 的文件。 [info]root 会根据完整的 URI 请求来映射，也就是/path/uri。[/info] 因此，前面的请求映射为 path/weblogs/httplogs/www.ttlsa.com-access.log。</div><div class="line"></div><div class="line">例子二：</div><div class="line"></div><div class="line"></div><div class="line">location ^~ /binapp/ &#123;</div><div class="line">limit_conn limit 4; limit_rate 200k; internal;</div><div class="line">alias /data/statics/bin/apps/;</div><div class="line">&#125;</div><div class="line">alias 会把 location 后面配置的路径丢弃掉，把当前匹配到的目录指向到指定的目录。如果一个请求的 URI 是</div><div class="line">/binapp/a.ttlsa.com/favicon 时，web 服务器将会返回服务器上的</div><div class="line">/data/statics/bin/apps/a.ttlsa.com/favicon.jgp 的文件。 [warning]1. 使用 alias 时，目录名后面一定要加”/”。</div><div class="line">2. alias 可以指定任何名称。</div><div class="line">3. alias 在使用正则匹配时，必须捕捉要匹配的内容并在指定的内容处使用。</div><div class="line">4.	alias 只能位于 location 块中。[/warning]</div></pre></td></tr></table></figure></p>
<p>总结一下，就是，root相当于是根，特别之处根是在什么地方，</p>
<p>而alias是别号，也就是映射的那个路径，还可以是其他的别的地方，因此本身要去掉</p>
<h1 id="nginx变量"><a href="#nginx变量" class="headerlink" title="nginx变量"></a>nginx变量</h1><p>ngx_http_core_module 模块提供了大量的变量</p>
<pre><code>参数名称    注释
$arg_PARAMETER    HTTP 请求中某个参数的值，如/index.php?site=www.ttlsa.com，可以用$arg_site 取 得 www.ttlsa.com 这个值.
$args HTTP    请求中的完整参数。例如，在请求/index.php?width=400&amp;height=200 中，$args 表示 字符串 width=400&amp;height=200.
$binary_remote_addr    二进制格式的客户端地址。例如：\x0A\xE0B\x0E
$body_bytes_sent       表示在向客户端发送的 http 响应中，包体部分的字节数
$content_length         表示客户端请求头部中的 Content-Length 字段
$content_type    表示客户端请求头部中的 Content-Type 字段
$cookie_COOKIE          表示在客户端请求头部中的 cookie 字段
$document_root          表示当前请求所使用的 root 配置项的值
$uri    表示当前请求的 URI，不带任何参数
$document_uri    与$uri 含义相同
$request_uri    表示客户端发来的原始请求 URI，带完整的参数。$uri 和$document_uri 未必是用户的 原始请求，在内部重定向后可能是重定向后的 URI，而$request_uri 永远不会改变，始终是客户端的原始 URI.
$host    表示客户端请求头部中的 Host 字段。如果 Host 字段不存在，则以实际处理的 server
（虚拟主机）名称代替。如果 Host 字段中带有端口，如 IP:PORT，那么$host 是去掉端口的，它的值为 IP。$host 是全小写的。这些特性与 http_HEADER 中的 http_host 不同，http_host 只取出 Host 头部对应的值。
$hostname    表示 Nginx 所在机器的名称，与 gethostbyname 调用返回的值相同
$http_HEADER    表示当前 HTTP 请求中相应头部的值。HEADER 名称全小写。例如，示请求中 Host 头部 对应的值    用 $http_host 表
$sent_http_HEADER    表示返回客户端的 HTTP 响应中相应头部的值。HEADER 名称全小写。例如，用 $sent_ http_content_type 表示响应中 Content-Type 头部对应的值
$is_args    表示请求中的 URI 是否带参数，如果带参数，$is_args 值为 ?，如果不带参数，则是 空字符串
$limit_rate    表示当前连接的限速是多少，0 表示无限速
$nginx_version          表示当前 Nginx 的版本号
$query_string    请求 URI 中的参数，与 $args 相同，然而 $query_string 是只读的不会改变
$remote_addr    表示客户端的地址
$remote_port    表示客户端连接使用的端口
$remote_user    表示使用 Auth Basic Module 时定义的用户名
$request_filename     表示用户请求中的 URI 经过 root 或 alias 转换后的文件路径
$request_body    表示 HTTP 请求中的包体，该参数只在 proxy_pass 或 fastcgi_pass 中有意义
$request_body_file      表示 HTTP 请求中的包体存储的临时文件名
$request_completion    当请求已经全部完成时，其值为 “ok”。若没有完成，就要返回客户端，则其值为空字 符串；或者在断点续传等情况下使用 HTTP range 访问的并不是文件的最后一块，那么其值也是空字符串。
$request_method        表示 HTTP 请求的方法名，如 GET、PUT、POST 等
$scheme    表示 HTTP scheme，如在请求 https://nginx.com/中表示 https
$server_addr    表示服务器地址
$server_name    表示服务器名称
$server_port    表示服务器端口
$server_protocol        表示服务器向客户端发送响应的协议，如 HTTP/1.1 或 HTTP/1.0
</code></pre><h1 id="nginx-日志配置"><a href="#nginx-日志配置" class="headerlink" title="nginx 日志配置"></a>nginx 日志配置</h1><p>日志对于统计排错来说非常有利的。 日志格式通过 log_format 命令来定义。ngx_http_log_module 是用来定义请求日志格式的。</p>
<ol>
<li>access_log<br>语法: access_log path [format [buffer=size [flush=time]]];<br>默认值: access_log logs/access.log combined;</li>
<li>log_format 指令<br>语法: log_format name string …;<br>默认值: log_format combined “…”<br>有一个默认的无需设置的 combined 日志格式，相当于 apache 的 combined 日志格式，如下所示：</li>
</ol>
<pre><code>log_format    combined    &apos;$remote_addr - $remote_user    [$time_local]    &apos;
&apos; &quot;$request&quot;    $status    $body_bytes_sent    &apos; &apos; &quot;$http_referer&quot;    &quot;$http_user_agent&quot; &apos;;


log_format    proxy    &apos;$http_x_forwarded_for - $remote_user    [$time_local]    &apos; &apos; &quot;$request&quot;    $status $body_bytes_sent &apos;
&apos; &quot;$http_referer&quot;    &quot;$http_user_agent&quot; &apos;; 
</code></pre><ol>
<li>日志格式变量</li>
</ol>
<pre><code>$remote_addr, $http_x_forwarded_for 记录客户端 IP 地址
$remote_user 记录客户端用户名称
$request 记录请求的 URL 和 HTTP 协议
$status 记录请求状态
$body_bytes_sent 发送给客户端的字节数，不包括响应头的大小； 该变量与 Apache 模块 mod_log_config 里的 “%B”参数兼容。
$bytes_sent 发送给客户端的总字节数。
$connection 连接的序列号。
$connection_requests 当前通过一个连接获得的请求数量。
$msec 日志写入时间。单位为秒，精度是毫秒。
$pipe 如果请求是通过 HTTP 流水线(pipelined)发送，pipe 值为“p”，否则为“.”。
$http_referer 记录从哪个页面链接访问过来的
$http_user_agent 记录客户端浏览器相关信息
$request_length 请求的长度（包括请求行，请求头和请求正文）。
$request_time 请求处理时间，单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送 给客户端后进行日志写入为止。
$time_iso8601 ISO8601 标准格式下的本地时间。
$time_local 通用日志格式下的本地时间。
</code></pre><ol>
<li><p>open_log_file_cache 指令</p>
<p>语法: open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time]; open_log_file_cache off;<br>默认值: open_log_file_cache off;<br>配置段: http, server, location<br>对于每一条日志记录，都将是先打开文件，再写入日志，然后关闭。可以使用 open_log_file_cache 来设置日志 文件缓存(默认是 off)，格式如下：<br>参数注释如下：<br>max:设置缓存中的最大文件描述符数量，如果缓存被占满，采用 LRU 算法将描述符关闭。 inactive:设置存活时间，默认是 10s<br>min_uses:设置在 inactive 时间段内，日志文件最少使用多少次后，该日志文件描述符记入缓存中，默认是 1 次 valid:设置检查频率，默认 60s<br>off：禁用缓存 实例如下：</p>
<pre><code>open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;
</code></pre></li>
<li><p>log_not_found 指令</p>
<p> 语法: log_not_found on | off;<br> 默认值: log_not_found on;<br> 配置段: http, server, location<br> 是否在 error_log 中记录不存在的错误。默认是。</p>
</li>
<li><p>log_subrequest 指令</p>
<p>语法: log_subrequest on | off;<br>默认值: log_subrequest off;<br>配置段: http, server, location<br>是否在 access_log 中记录子请求的访问日志。默认不记录。</p>
</li>
<li><p>rewrite_log 指令</p>
<p>由 ngx_http_rewrite_module 模块提供的。用来记录重写日志的。对于调试重写规则建议开启。    Nginx 重写规则 指南<br>语法: rewrite_log on | off; 默认值: rewrite_log off;<br>配置段: http, server, location, if<br>启用时将在 error log 中记录 notice 级别的重写日志。</p>
</li>
<li><p>error_log 指令</p>
<p>语法: error_log file | stderr | syslog:server=address[,parameter=value] [debug | info | notice | warn | error | crit | alert | emerg];<br>默认值: error_log logs/error.log error;<br>配置段: main, http, server,<br>location 配置错误日志。</p>
</li>
</ol>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2017/06/29/nginx2/" class="prev">上一篇</a><a href="/2017/06/27/java-encode/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="http://ghohankawk.github.io">韩坤</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>